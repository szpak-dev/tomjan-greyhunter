---
import Layout from "../../../layouts/Layout.astro";
import ManufacturerPage from "../../../layouts/ManufacturerPage.astro";
import { Breadcrumb } from "astro-bootstrap";
import { makeUrl } from "../../../libs/url";

import {
  categoryRepository,
  manufacturerRepository,
  siteRepository,
} from "../../../content";

export async function getStaticPaths() {
  const languages = siteRepository.getAvailableLanguages().map((l) => l.code);
  const paths = [];

  for (const lang of languages) {
    const marttiini = await manufacturerRepository.get("marttiini", lang);
    const manufacturers = [marttiini];

    for (const manufacturer of manufacturers) {
      const categories = await categoryRepository.findManufacturerCategories(
        manufacturer.id,
        lang
      );

      const ownerStory = siteRepository.getOwnerStory(manufacturer.id, lang);

      paths.push({
        params: {
          lang,
          manufacturer: manufacturer.id,
        },
        props: {
          manufacturer,
          categories,
          ownerStory,
        },
      });
    }
  }

  return paths;
}

const { lang } = Astro.params;
const { manufacturer, categories, ownerStory } = Astro.props;

const socials = siteRepository.getSocialAccounts();
const owner = siteRepository.getSiteOwner();
const languages = siteRepository.getAvailableLanguages();
const currentLanguage = siteRepository.getLanguage(lang);
const navigationItems = siteRepository.getNavigationItems(lang);
const t = siteRepository.getTranslator(lang);

// Build navigation items for all languages
const allNavigationItems: Record<string, any[]> = {};
for (const language of languages) {
  allNavigationItems[language.code] = siteRepository.getNavigationItems(language.code);
}
---

<Layout
  title={manufacturer.name}
  {lang}
  {socials}
  {owner}
  {languages}
  {currentLanguage}
  {navigationItems}
  {allNavigationItems}
>
  <Breadcrumb>
    <Breadcrumb.Item>
      <a href={makeUrl(Astro, { targetLocale: lang, path: "/" })}>
        {t("nav.home")}
      </a>
    </Breadcrumb.Item>
  </Breadcrumb>

  <ManufacturerPage
    manufacturer={manufacturer}
    categories={categories}
    ownerStory={ownerStory}
  />
</Layout>
