---
import { makeUrl } from "../../libs/url";
import type { AvailableLanguage, NavigationItem } from "../../content/site.repository";

interface Props {
  languages: AvailableLanguage[];
  currentLanguage: AvailableLanguage;
  currentId?: string;
  allNavigationItems: Record<string, NavigationItem[]>;
}

const { languages, currentLanguage, currentId, allNavigationItems } = Astro.props;

// Function to get the correct URL for a target language
function getLanguageUrl(targetLang: string): string {
  // If we have a currentId, find the corresponding slug in the target language
  if (currentId) {
    const targetNavItems = allNavigationItems[targetLang];
    const targetItem = targetNavItems?.find(item => item.id === currentId);
    
    if (targetItem) {
      // Use the slug for the target language
      return `/${targetLang}/${targetItem.slug}/`;
    }
  }
  
  // Fallback to the default behavior (just switch the locale)
  return makeUrl(Astro, { targetLocale: targetLang });
}
---

<div class="ui-language-selector dropdown d-inline-block ms-3">
  <button
    class="btn btn-outline-secondary dropdown-toggle btn-sm"
    type="button"
    data-bs-toggle="dropdown"
    aria-expanded="false"
  >
    {currentLanguage.flag}
  </button>
  <ul class="dropdown-menu">
    {
      languages.map(({ code, label, flag }) => (
        <li>
          <a class="dropdown-item" href={getLanguageUrl(code)} >
            {flag}
            {label}
          </a>
        </li>
      ))
    }
  </ul>
</div>
